<html>
<head>
<title>ImService test client</title>
</head>

<script src="jquery.min.js"></script>
<!--<script src="socket.io.js"></script>-->
<script>

var client;
var reqId = 0;
var roomId = 'No Room';

function reset() {
    reqId = 0;
    roomId = 'No Room';

    $("[id=status]").html('Not Connected');
    $("[id=userId]").html('');
    $("[id=socketId]").html('');
    $("[id=roomId]").html("No Room");
    $("[id=msgRecv]").html('');
    $("[id=jsonRecv]").html('');
    $("[id=jsonSend]").html('');
}

function connect() {
    reset();

    client = new WebSocket('ws://192.168.88.138:9877/');
    client.binaryType = 'arraybuffer';

	client.onopen = function() {
		console.log('Client onopen()');

		// var bytes = new Uint8Array([0x48, 0x65, 0x6C, 0x6C, 0x6F]); // Hello
		// client.send(bytes.buffer);
        $("[id=status]").html('Connected');

        login();
    };

	client.onclose = function(ev) {
        console.log('Client onclose()');

        $("[id=status]").html('Not Connected');

        reconnect();
    }

	client.onmessage = function(ev) {
        console.log('Client onmessage(), ' + ev.data);
        let obj = JSON.parse(ev.data);
        $("[id=jsonRecv]").html(ev.data);

        if( typeof(obj.errno) == "undefined" || obj.errno == 0 ) {
            if(obj.route == 'imLogin/login') {
                $("[id=userId]").html(obj.data.userId);
                $("[id=socketId]").html(obj.data.socketId);
                roomList();
            } else if(obj.route == 'imMan/roomList') {
                let roomListStr = '';
                for(let i = 0; i < obj.data.roomList.length; i++) {
                    roomListStr += obj.data.roomList[i];
                    roomListStr += ' ';
                }
                $("[id=roomList]").html(roomListStr);
            } else if(obj.route == 'imMan/roomCreate') {
                $("[id=roomId]").val(obj.data.roomId);
            } else if(obj.route == 'imMan/roomIn') {
                // $("[id=roomId]").html(obj.data.roomId);
            } else if(obj.route == 'imMan/roomOut') {
                $("[id=roomId]").html("No Room");
            } else if(obj.route == 'imShare/sendChatNotice') {
                $("[id=msgRecv]").html(obj.req_data.msg);
            }
        }
	};
};

function send(obj) {
    obj.id = reqId;
    data = JSON.stringify(obj);
    console.log('Client send(), ' + data);

    if( client.readyState == client.OPEN ) {
        $("[id=jsonSend]").html(data);
        client.send(data);
        reqId++;
        return true;
    } else {
        connect();
        return false;
    }
}

function login() {
    obj = {
        route:'imLogin/login',
        req_data:{
            userId:$("#userId").val(),
            sessionId:'session123456',
            pagename:7
        }
    }
    send(obj);
}

function logout() {
    obj = {
        route:'imLogin/logout',
        req_data:{
            sessionid:'session123456',
            pagename:7
        }
    }
    send(obj);
}

function roomList() {
    obj = {
        route:'imMan/roomList',
        req_data:{
            token:'token123456',
        }
    }
    send(obj);
}

function roomCreate() {
    obj = {
        route:'imMan/roomCreate',
        req_data:{
            token:'token123456',
        }
    }
    send(obj);
}

function roomIn() {
    obj = {
        route:'imMan/roomIn',
        req_data:{
            token:'token123456',
            roomId:$("#roomId").val(),
        }
    }
    send(obj);
}

function roomOut(roomId) {
    obj = {
        route:'imMan/roomOut',
        req_data:{
            token:'token123456',
            roomId:roomId,
        }
    }
    send(obj);
}

function broadcast(roomId, msg) {
    obj = {
        route:'imShare/sendLiveChat',
        req_data:{
            token:'token123456',
            roomId:roomId,
            msg:msg
        }
    }
    send(obj);
}

function sendMsg(userId, msg) {
    obj = {
        route:'imShare/sendMsg',
        req_data:{
            token:'token123456',
            toUserId:userId,
            msg:msg
        }
    }
    send(obj);
}

function reconnect() {
    // console.log('Client reconnect()');
    // setTimeout(() => {
    //     if( client.readyState == client.OPEN ) {
    //         // 连接已经成功, 退出循环
    //     } else if(client.readyState == client.CLOSED) {
    //         // 开始连接
    //         connect();
    //     }  else {
    //         // 继续等待重连
    //         reconnect();
    //     }
    // }, 5000);
}

connect();

</script>

<!--<body onload="connect()">-->
<body>
<div id="">
    <div id="login">
        status : <lable id="status">Not Connected</lable><br>
        userId : <input id="userId" type="text" name="" value="max" /><br>
        socketId : <lable id="socketId"> </lable><br>
        <button onclick="login()">login</button>
        <button onclick="logout()">logout</button>
    </div>
    <div id="room">
        roomIdList : <lable id="roomList"></lable><br>
        roomId : <input id="roomId" type="text" name="" value="No Room" /><br>
        roomMsg : <input id="roomMsg" type="text" name="" value="Room Message" /><br>
        <button onclick=roomCreate()>roomCreate</button>
        <button onclick=roomIn()>roomIn</button>
        <button onclick=roomOut($("#roomId").val())>roomOut</button>
        <button onclick=broadcast($("#roomId").val(),$("#roomMsg").val())>broadcast</button>
    </div>
    <div>
        toUserId : <input id="toUserId" type="text" name="" value="max" /><br>
        msg : <input id="msg" type="text" name="" value="User Message" /><br>
        <button onclick=sendMsg($("#toUserId").val(),$("#msg").val())>sendMsg</button>
    </div>
    <div>
        msg recv : <lable id="msgRecv" />
    </div>
    <div style="color:#00F000">
        json recv : <lable id="jsonRecv" />
    </div>
    <div style="color:#F00000">
        json send : <lable id="jsonSend" />
    </div>
</div>
</body>
</html>
